<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.heartof.auction.service.mapper.QnaMapper">
	<resultMap type="BoardVO" id="boardList">
		<id column="RN" property="RN" />
		<result column="BOARD_NUM" property="BOARD_NUM" />
		<result column="WRITER_NM" property="WRITER_NM" />
		<result column="TITLE" property="TITLE" />
		<result column="WRITE_DATE" property="WRITE_DATE" />
		<result column="REVIEW_CNT" property="REVIEW_CNT" />
		<result column="QUES_CD" property="QUES_CD" />
		<result column="MEMB_ID" property="MEMB_ID" />
		<association column="TOT" property="TOT"  javaType="int" select="listTot"/>
		<collection property="files" javaType="java.util.ArrayList" ofType="AttacFileVO" 
			column="BOARD_NUM" select="listAttachFile"/>
		<collection property="replys" javaType="java.util.ArrayList" ofType="BoardVO" 
			column="BOARD_NUM" select="listReplys"/>			
	</resultMap>
	
	<select id="listAttachFile" parameterType="int" resultType="AttacFileVO">
		SELECT
			ATTAC_FILE_NUM,
			FILE_NM,
			FILE_PATH,
			REAL_NM,
			FILE_SIZE
		FROM 
			ATTAC_FILE
		WHERE
			BOARD_NUM = #{BOARD_NUM} 		
	</select>
	
	<select id="listReplys" parameterType="int" resultType="BoardVO">
		SELECT 
			ROWNUM RN,
		    B.BOARD_NUM,
		    B.TITLE,
		    B.WRITER_NM,
		    B.WRITE_DATE,
		    B.HIGH_BOARD_NUM,
		    B.REVIEW_CNT,
		    U.MEMB_ID
		FROM 
		    BOARD B INNER JOIN USR U
    		ON B.MEMB_NUM = U.MEMB_NUM
		WHERE
			B.HIGH_BOARD_NUM = #{BOARD_NUM}
	</select>
	
	<select id="listTot" resultType="int" >
			SELECT
			    COUNT(*) AS TOT
			FROM 
			    BOARD
			WHERE 
			    QUES_CD = '2101' 
	</select>
	
	<select id="list" resultMap="boardList" parameterType="PageVO">
		SELECT RN, BOARD_NUM, HIGH_BOARD_NUM, TITLE, CONT,
			    REVIEW_CNT, QUES_CD, MEMB_ID, TOT
		FROM (
			SELECT
			    ROWNUM RN,
			    BOARD_NUM, 
			    HIGH_BOARD_NUM, 
			    TITLE,
			    CONT,
			    REVIEW_CNT,
			    QUES_CD,
			    U.MEMB_ID,
			    0 AS TOT
			FROM 
			    BOARD B INNER JOIN USR U
			    ON B.MEMB_NUM = U.MEMB_NUM
			WHERE 
			    QUES_CD = '2101' 
			) BOARD 
		WHERE 
			RN >= #{START} AND 
			#{END} >= RN
	</select>
	
	<select id="searchlist" resultMap="boardList" parameterType="PageVO">
		SELECT RN, BOARD_NUM, HIGH_BOARD_NUM, TITLE, CONT,
			    REVIEW_CNT, QUES_CD, MEMB_ID, TOT
		FROM (
			SELECT
			    ROWNUM RN,
			    BOARD_NUM, 
			    HIGH_BOARD_NUM, 
			    TITLE,
			    CONT,
			    REVIEW_CNT,
			    QUES_CD,
			    U.MEMB_ID,
			    0 AS TOT
			FROM 
			    BOARD B INNER JOIN USR U
			    ON B.MEMB_NUM = U.MEMB_NUM
			WHERE 
			    QUES_CD = '2101' 
			) BOARD 
		WHERE 
			RN >= #{START} AND 
			#{END} >= RN
	</select>
	
	
	<select id="detail" parameterType="int" resultType="BoardVO">
		SELECT 
		    c.BOARD_NUM, 
		    c.TITLE,
		    c.WRITER_NM,
		    c.WRITE_DATE,
		    c.HIGH_BOARD_NUM, 
		    c.REVIEW_CNT,
		    c.QUES_CD,
		    p.MEMB_ID
		FROM 
		    BOARD c INNER JOIN USR p 
		    ON c.MEMB_NUM = p.MEMB_NUM		
		where 
			c.BOARD_NUM = #{BOARD_NUM}
	 </select>
	 
	 <insert id="insert" parameterType="BoardVO">
	 		INSERT INTO BOARD
			( BOARD_NUM, TITLE, CONT, WRITER_NM, WRITE_DATE,
			  REVIEW_CNT, MEMB_NUM, QUES_CD) VALUES 
			(BOARD_SEQ.NEXTVAL, #{TITLE}, #{CONT}, #{WRITER_NM},
				0, #{MEMB_NUM}, '2202'
			)
	 </insert>
	 
	 <update id="update" parameterType="BoardVO">
	 		UPDATE BOARD
			SET TITLE = #{TITLE},
			    CONT = #{CONT}
			WHERE 
				MEMB_NUM = #{MEMB_NUM}
	 </update>
	 
	 <update id="updateHitCount" parameterType="int">
	 		UPDATE BOARD
			SET 
				REVIEW_CNT = #{REVIEW_CNT} + 1			    
			WHERE 
				MEMB_NUM = #{MEMB_NUM}
	 </update>
	 
	 <update id="updateQuesCD" parameterType="int">
	 		UPDATE BOARD
			SET 
				REVIEW_CNT = #{REVIEW_CNT} + 1			    
			WHERE 
				MEMB_NUM = #{MEMB_NUM}
	 </update>
	 
	 <delete id="delete" parameterType="int">
	  		DELETE
			FROM BOARD
			WHERE MEMB_NUM = #{MEMB_NUM} 
	 </delete>
	 
	 <delete id="deleteRelatedFile" parameterType="int">
	  		DELETE
			FROM ATTAC_FILE
			WHERE MEMB_NUM = #{MEMB_NUM} 
	 </delete>
</mapper>