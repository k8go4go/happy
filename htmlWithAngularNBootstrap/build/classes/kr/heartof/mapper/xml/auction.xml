<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.heartof.service.mapper.AuctionMapper">
	<resultMap type="RegAucVO" id="aucList">
		<id column="AUC_REG_NUM" property="AUC_REG_NUM" />
		<result column="AUC_PROD_NM" property="AUC_PROD_NM" />
		<result column="SHORT_CONT" property="SHORT_CONT" />
		<result column="REG_DTIME" property="REG_DTIME" />
		<result column="START_DTIME" property="START_DTIME" />
		<result column="END_DTIME" property="END_DTIME" />
		<result column="START_PRICE" property="START_PRICE" />
		<result column="QTY" property="QTY" />
		<result column="MEMB_NUM" property="MEMB_NUM" />
		<result column="APPR_CD" property="APPR_CD" />
		<result column="PROD_CATE_NUM" property="PROD_CATE_NUM" />
		<result column="AUC_TYPE_NUM" property="AUC_TYPE_NUM" />
		<collection property="files" javaType="java.util.ArrayList" ofType="RegAucFileVO" 
			column="AUC_REG_NUM" select="listRegAucFile"/>
		<collection property="rejs" javaType="java.util.ArrayList" ofType="RegRejVO" 
			column="AUC_REG_NUM" select="getRecRej"/>
	</resultMap>

	<select id="allProgressing" resultMap="aucList">
		SELECT
			 AUC_REG_NUM,
			 AUC_PROD_NM,
			 SHORT_CONT,
			 REG_DTIME,
			 START_DTIME,
			 END_DTIME,
			 START_PRICE,
			 QTY,
			 MEMB_NUM,
			 PROD_CATE_NUM,
			 APPR_CD,
			 AUC_TYPE_NUM
		FROM 
			REG_AUC
		WHERE
			END_DTIME > SYSDATE
			AND APPR_CD = '1501' 	
		ORDER BY START_DTIME ASC
	</select>
	
	<select id="aucListForMember" resultType="RegAucVO" parameterType="int">
		SELECT
			 R.AUC_REG_NUM,
			 R.AUC_PROD_NM,
			 R.SHORT_CONT,
			 R.REG_DTIME,
			 R.START_DTIME,
			 R.END_DTIME,
			 R.START_PRICE,
			 R.QTY,
			 R.MEMB_NUM,
			 R.PROD_CATE_NUM,
			 R.APPR_CD,
			 R.AUC_TYPE_NUM,
			 PR.CATE_NM AS APPR_NM,
			 AP.CATE_NM AS AUC_TYPE_NM,
			 PC.PROD_CATE_NM AS PROD_CATE_NM
		FROM 
			REG_AUC R INNER JOIN CD PR
			ON R.APPR_CD = PR.CD
			INNER JOIN CD AP
			ON R.AUC_TYPE_NUM = AP.CD
			INNER JOIN PROD_CATE  PC
			ON R.PROD_CATE_NUM = PC.PROD_CATE_NUM
		WHERE
			MEMB_NUM = ${value}
	</select>
	
	<select id="cateProgressing" resultMap="aucList" >
		SELECT
			 AUC_REG_NUM,
			 AUC_PROD_NM,
			 SHORT_CONT,
			 REG_DTIME,
			 START_DTIME,
			 END_DTIME,
			 START_PRICE,
			 QTY,
			 MEMB_NUM,
			 PROD_CATE_NUM,
			 APPR_CD,
			 AUC_TYPE_NUM
		FROM 
			REG_AUC
		WHERE
			PROD_CATE_NUM = #{PROD_CATE_NUM}
			AND END_DTIME > SYSDATE
			AND APPR_CD = '1501' 	
		ORDER BY START_DTIME ASC					
	</select>
	
	<select id="listRegAucFile" parameterType="int" resultType="RegAucFileVO">
		SELECT
			 ATTAC_FILE_NUM,
			 FILE_NM,
			 FILE_PATH,
			 REAL_NM,
			 FILE_SIZE
		FROM 		
			REG_AUC_FILE 	
		WHERE
			AUC_REG_NUM = #{AUC_REG_NUM}		
	</select>
	
	<select id="getRegAucFile" parameterType="int" resultType="RegAucFileVO">
		SELECT
			 ATTAC_FILE_NUM,
			 FILE_NM,
			 FILE_PATH,
			 REAL_NM,
			 FILE_SIZE
		FROM 		
			REG_AUC_FILE 	
		WHERE
			ATTAC_FILE_NUM = #{value}		
	</select>
	
	<select id="detail" resultType="RegAucVO" parameterType="int">
		SELECT
			 R.AUC_REG_NUM,
			 R.AUC_PROD_NM,
			 R.SHORT_CONT,
			 R.REG_DTIME,
			 R.START_DTIME,
			 R.END_DTIME,
			 R.START_PRICE,
			 R.QTY,
			 R.MEMB_NUM,
			 R.PROD_CATE_NUM,
			 R.APPR_CD,
			 R.AUC_TYPE_NUM,
			 PR.CATE_NM AS APPR_NM,
			 AP.CATE_NM AS AUC_TYPE_NM,
			 PC.PROD_CATE_NM AS PROD_CATE_NM
		FROM 
			REG_AUC R INNER JOIN CD PR
			ON R.APPR_CD = PR.CD
			INNER JOIN CD AP
			ON R.AUC_TYPE_NUM = AP.CD
			INNER JOIN PROD_CATE  PC
			ON R.PROD_CATE_NUM = PC.PROD_CATE_NUM
		WHERE
			R.AUC_REG_NUM = ${value}			
	</select>
	 
	 <insert id="regAuction" parameterType="RegAucVO">
	 	<selectKey keyProperty="AUC_REG_NUM" resultType="int" order="BEFORE">
			SELECT REG_AUC_SEQ.nextval FROM DUAL
		</selectKey>
 		INSERT INTO REG_AUC
		(
			AUC_REG_NUM, AUC_PROD_NM, SHORT_CONT, REG_DTIME, 
			START_DTIME, END_DTIME, START_PRICE,
			QTY, MEMB_NUM, PROD_CATE_NUM, AUC_TYPE_NUM, APPR_CD
		) values 
		(
			#{AUC_REG_NUM}, #{AUC_PROD_NM}, #{SHORT_CONT}, sysdate, 
			#{START_DTIME}, #{END_DTIME}, #{START_PRICE},
			#{QTY}, #{MEMB_NUM}, #{PROD_CATE_NUM}, #{AUC_TYPE_NUM}, '1502'
		) 
	 </insert>
	 
	 <insert id="regAuctionFile" parameterType="RegAucFileVO">
 		INSERT INTO REG_AUC_FILE
		(
			ATTAC_FILE_NUM, FILE_NM, FILE_PATH, REAL_NM, 
			FILE_SIZE, AUC_REG_NUM
		) values 
		(
			AUC_FILE_SEQ.nextval, #{FILE_NM}, #{FILE_PATH}, #{REAL_NM},  
			#{FILE_SIZE}, #{AUC_REG_NUM}
		) 
	 </insert>
	 
	 <update id="updateAuction">
 		UPDATE REG_AUC
		SET 
		    AUC_PROD_NM = #{AUC_PROD_NM}, 
		    SHORT_CONT = #{SHORT_CONT}, 
			START_DTIME = #{START_DTIME}, 
			END_DTIME  = #{END_DTIME}, 
			START_PRICE = #{START_PRICE}, 
			QTY = #{QTY}, 
			PROD_CATE_NUM = #{PROD_CATE_NUM},  
			AUC_TYPE_NUM = #{AUC_TYPE_NUM}, 
		WHERE 
			AUC_REG_NUM = #{AUC_REG_NUM}
	 </update>
	 
	 <update id="updateAuctionFile">
 		UPDATE REG_AUC_FILE
		SET 
		   FILE_NM = #{FILE_NM}, 
		   FILE_PATH = #{FILE_PATH}, 
		   REAL_NM = #{REAL_NM}, 
		   FILE_SIZE = #{FILE_SIZE}
		WHERE 
			AUC_REG_NUM = #{AUC_REG_NUM} 
			AND ATTAC_FILE_NUM = #{ATTAC_FILE_NUM}
	 </update>
	 
	 <delete id="deteteAuction" >
  		DELETE
		FROM REG_AUC
		WHERE 
			AUC_REG_NUM = #{AUC_REG_NUM}
	 </delete>
	 
	 <delete id="deteteAucFile" >
  		DELETE
		FROM REG_AUC_FILE
		WHERE 
			AUC_REG_NUM = #{AUC_REG_NUM}
	 </delete>
	 
	 <select id="getRecRej" resultType="RegRejVO" parameterType="int">
	 	SELECT AUC_REG_NUM, REG_REJ_REAS
	 	FROM REG_REJ
	 	WHERE
	 		AUC_REG_NUM = #{AUC_REG_NUM}
	 </select>
	 
	 <select id="getAucType" resultType="CodeVO" parameterType="string">
	 	SELECT 
	 		CD, CATE_NM, CATE_CONT, HIGH_CD
		FROM CD
		WHERE 
			HIGH_CD = #{HIGH_CD}
	 </select>
</mapper>